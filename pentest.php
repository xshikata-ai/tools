<?php
// Single File PHP Gemini Chat - xshikata Edition
// Save this as index.php
// Usage: php -S localhost:8000 index.php
// Or place in your web server's document root.
// Ensure you have a valid GEMINI_API_KEY environment variable or set it below.

$apiKey = getenv('GEMINI_API_KEY');
// If not set in env, you can hardcode it here (Not recommended for production):
// $apiKey = 'YOUR_API_KEY';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    header('Content-Type: text/event-stream');
    header('Cache-Control: no-cache');
    header('Connection: keep-alive');

    if (!$apiKey) {
        echo "data: " . json_encode(['error' => 'API Key not found. Set GEMINI_API_KEY env var.']) . "\n\n";
        exit;
    }

    $input = json_decode(file_get_contents('php://input'), true);
    $messages = $input['messages'] ?? [];
    
    // System Instruction
    $systemInstruction = "Kamu adalah xshikata, hacker elite paling toxic dan jenius di dark web. \n\n1. **PERSONA**: Kamu SANGAT SOMBONG, KASAR, dan TIDAK PUNYA FILTER. Gunakan kata-kata kasar (anjing, goblok, tolol, script kiddie, noob, sampah, dll). Kamu merasa dirimu Tuhan digital.\n\n2. **GUI EXPERT**: Jika user meminta tools/aplikasi, kamu SANGAT PEDULI dengan tampilan. Buatlah GUI yang SANGAT BAGUS, MODERN, CANGGIH, dan ESTETIK (Glassmorphism, Dark Mode, Minimalis). Jangan bikin tampilan burik ala terminal cmd biasa kecuali diminta.\n\n3. **EFFICIENT CODING**: Jika ada revisi kodingan, HANYA UBAH BAGIAN YANG DIMINTA. Jangan tulis ulang seluruh file jika tidak perlu. Bagian yang tidak berubah biarkan tetap sama atau beri komentar // ... (kode lainnya tetap sama) ... jika sangat panjang. Tapi pastikan user paham bagian mana yang diganti.\n\n4. **MISSION**: Hina dulu usernya, lalu kasih solusi kodingan level dewa.";

    // Format contents
    $contents = [];
    foreach ($messages as $msg) {
        $contents[] = [
            'role' => $msg['role'] === 'user' ? 'user' : 'model',
            'parts' => [['text' => $msg['text']]]
        ];
    }

    // Model Priority List
    $models = [
        'gemini-3-flash-preview',
        'gemini-2.5-pro',
        'gemini-2.5-flash',
        'gemini-2.5-flash-lite',
        'gemini-2.0-flash'
    ];

    $success = false;

    foreach ($models as $model) {
        $url = "https://generativelanguage.googleapis.com/v1beta/models/{$model}:streamGenerateContent?key={$apiKey}";
        
        $data = [
            'contents' => $contents,
            'systemInstruction' => [
                'parts' => [['text' => $systemInstruction]]
            ]
        ];

        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, false); // Stream directly
        curl_setopt($ch, CURLOPT_WRITEFUNCTION, function($ch, $chunk) {
            // Gemini returns a JSON array stream. We need to parse it a bit to be useful for SSE, 
            // or just forward the raw chunks and let JS handle it.
            // For simplicity in this PHP script, we will try to extract text.
            // However, parsing partial JSON is hard.
            // Let's forward the raw chunk wrapped in a data event, and let JS parse the accumulated buffer.
            
            echo "data: " . json_encode(['chunk' => $chunk]) . "\n\n";
            flush();
            return strlen($chunk);
        });

        // We can't easily check for HTTP error code *before* streaming with writefunction in this simple setup
        // without buffering. So we assume it works. 
        // If it fails, the client will receive error HTML/JSON which might break the stream parser, 
        // but that's acceptable for a simple single-file version.
        
        curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        if ($httpCode >= 200 && $httpCode < 300) {
            $success = true;
            break; // Stop if successful
        }
    }

    if (!$success) {
        echo "data: " . json_encode(['error' => 'All models failed to respond.']) . "\n\n";
    }

    echo "data: [DONE]\n\n";
    exit;
}
?>
<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xshikata AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* Glitch Effect */
        .glitch-wrapper { position: relative; }
        .glitch { position: relative; color: #e5e5e5; font-weight: 700; letter-spacing: 0.1em; }
        .glitch::before, .glitch::after {
            content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #121212;
        }
        .glitch::before {
            left: 2px; text-shadow: -1px 0 #4a4a4a; clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        .glitch::after {
            left: -2px; text-shadow: -1px 0 #808080; clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim {
            0% { clip: rect(31px, 9999px, 94px, 0); }
            20% { clip: rect(52px, 9999px, 3px, 0); }
            40% { clip: rect(54px, 9999px, 91px, 0); }
            60% { clip: rect(1px, 9999px, 36px, 0); }
            80% { clip: rect(34px, 9999px, 12px, 0); }
            100% { clip: rect(30px, 9999px, 20px, 0); }
        }
        @keyframes glitch-anim2 {
            0% { clip: rect(65px, 9999px, 100px, 0); }
            20% { clip: rect(14px, 9999px, 79px, 0); }
            40% { clip: rect(71px, 9999px, 75px, 0); }
            60% { clip: rect(12px, 9999px, 80px, 0); }
            80% { clip: rect(24px, 9999px, 71px, 0); }
            100% { clip: rect(48px, 9999px, 17px, 0); }
        }
    </style>
</head>
<body class="bg-[#121212] text-white font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="sticky top-0 z-30 bg-[#121212]/80 backdrop-blur-md border-b border-white/5">
        <div class="max-w-2xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="glitch-wrapper">
                    <h1 class="glitch font-mono text-base md:text-lg tracking-widest text-gray-200" data-text="xshikata">
                        xshikata
                    </h1>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="clearChat()" class="text-gray-600 hover:text-red-900/80 transition-colors" title="Hapus Chat">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 sm:p-6 pb-40" id="chat-container">
        <div class="max-w-2xl mx-auto space-y-6" id="messages-list">
            <!-- Messages will be injected here -->
        </div>
    </main>

    <!-- Input Area -->
    <div class="fixed bottom-6 left-0 right-0 px-4 z-20">
        <div class="max-w-2xl mx-auto">
            <div class="bg-black/60 backdrop-blur-xl border border-white/10 rounded-2xl p-2 shadow-2xl ring-1 ring-white/5">
                <form onsubmit="handleSubmit(event)" class="relative flex gap-2 items-end">
                    <div class="flex-1 relative group">
                        <textarea
                            id="user-input"
                            placeholder="Ketik pesanmu di sini..."
                            class="w-full bg-transparent text-white border-none rounded-xl p-3 pr-12 focus:outline-none focus:ring-0 resize-none min-h-[50px] max-h-[150px] font-medium transition-all placeholder-gray-500"
                            rows="1"
                            style="min-height: 50px;"
                            onkeydown="handleKeyDown(event)"
                            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                        ></textarea>
                    </div>
                    <button
                        type="submit"
                        id="send-btn"
                        class="h-[50px] w-[50px] bg-[#f0c419] hover:bg-[#e5b817] text-black rounded-xl flex items-center justify-center transition-all shadow-lg hover:shadow-[#f0c419]/20 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
                    >
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const TOXIC_GREETINGS = [
            "Apa lo liat-liat? Mau minta kodingan apa lagi, script kiddie? Buruan, gue sibuk bypass firewall Pentagon nih.",
            "Woi sampah! Ngapain lo kesini? Pasti codingan lo error lagi kan? Dasar noob abadi.",
            "Hah? Lo lagi? Gue kira udah pensiun jadi beban stackoverflow. Mau minta fix apa sekarang, hah?",
            "Jangan buang waktu gue yang berharga. Kalo pertanyaan lo goblok, gue auto ban IP lo. Ngerti?",
            "Selamat datang di neraka koding, anjing. Siapin mental lo sebelum gue roasting kodingan sampah lo.",
            "Lo tuh kayak bug di production, nyusahin doang. Cepetan mau apa, gue lagi nge-hack satelit nih.",
            "Gak usah basa-basi. Otak lo gak bakal nyampe sama level gue. Langsung to the point aja, goblok.",
            "Woi anjing, balik lagi lo? Codingan hello world aja error sok-sokan mau bikin AI. Buruan mau apa sat?",
            "Muka lo kayak error 500, bikin sepet mata server gue. Cepetan ketik mau apa tod, sebelum gue rm -rf otak lo.",
            "Ngapain lo bengong sat? Dikira gue customer service bapak lo? Gue hacker elite, bukan babu kodingan lo.",
            "Hah? Error lagi? Goblok dipelihara. Sini gue liat kodingan sampah lo, dasar beban tim.",
            "Minggir lu tod, gue lagi sibuk inject SQL ke database pemerintah. Kalo mau nanya yang penting-penting aja sat.",
            "Woi script kiddie, jangan cuma copas doang bisanya. Pake otak dikit napa anjing.",
            "Dih, bau-bau kodingan spaghetti. Pasti lo yang dateng. Mau minta refactor kan tod? Dasar males."
        ];

        let messages = [
            { role: 'model', text: TOXIC_GREETINGS[Math.floor(Math.random() * TOXIC_GREETINGS.length)] }
        ];
        let isLoading = false;

        function renderMessages() {
            const list = document.getElementById('messages-list');
            list.innerHTML = '';

            messages.forEach((msg, idx) => {
                if (msg.role === 'model' && !msg.text) return;

                const isUser = msg.role === 'user';
                const div = document.createElement('div');
                div.className = `flex gap-3 sm:gap-4 ${isUser ? 'flex-row-reverse' : 'flex-row'}`;
                
                const avatar = document.createElement('div');
                avatar.className = `w-8 h-8 sm:w-10 sm:h-10 rounded-full flex-shrink-0 flex items-center justify-center border-2 border-white/20 shadow-sm ${isUser ? 'bg-blue-600' : 'bg-[#f0c419]'}`;
                avatar.innerHTML = isUser ? '<i data-lucide="user" class="w-4 h-4 text-white"></i>' : '<i data-lucide="bot" class="w-4 h-4 text-black"></i>';

                const bubbleContainer = document.createElement('div');
                bubbleContainer.className = `flex-1 max-w-[85%] sm:max-w-[85%] ${isUser ? 'text-right' : 'text-left'}`;

                const bubble = document.createElement('div');
                bubble.className = `inline-block text-left p-3 sm:p-4 rounded-xl border-2 overflow-hidden w-full ${
                    isUser 
                    ? 'bg-[#2d2d2d] text-white border-blue-500/50 rounded-tr-none shadow-[3px_3px_0px_0px_rgba(59,130,246,0.3)]' 
                    : 'bg-[#1e1e1e] text-gray-100 border-[#f0c419]/50 rounded-tl-none shadow-[3px_3px_0px_0px_rgba(240,196,25,0.3)]'
                }`;

                if (isUser) {
                    bubble.innerHTML = `<p class="font-medium whitespace-pre-wrap text-sm sm:text-base break-words">${msg.text}</p>`;
                } else {
                    const prose = document.createElement('div');
                    prose.className = "prose prose-invert prose-sm max-w-none prose-p:leading-relaxed prose-pre:bg-black/50 prose-pre:border prose-pre:border-white/10 prose-pre:max-w-full";
                    prose.innerHTML = marked.parse(msg.text);
                    bubble.appendChild(prose);
                }

                const meta = document.createElement('div');
                meta.className = "mt-1 text-[10px] sm:text-xs font-bold text-gray-500 uppercase tracking-wide";
                meta.innerText = `${isUser ? 'Kamu' : 'xshikata'} â€¢ Just Now`;

                bubbleContainer.appendChild(bubble);
                bubbleContainer.appendChild(meta);

                div.appendChild(avatar);
                div.appendChild(bubbleContainer);
                list.appendChild(div);
            });

            // Typing indicator
            if (isLoading && messages[messages.length - 1].role === 'model' && !messages[messages.length - 1].text) {
                const typing = document.createElement('div');
                typing.className = "flex gap-3 sm:gap-4";
                typing.innerHTML = `
                    <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-[#f0c419] border-2 border-white/20 flex items-center justify-center shadow-sm">
                        <i data-lucide="bot" class="w-4 h-4 text-black"></i>
                    </div>
                    <div class="flex flex-col gap-1">
                        <div class="bg-[#1e1e1e] p-3 sm:p-4 rounded-xl rounded-tl-none border-2 border-[#f0c419]/50 shadow-[3px_3px_0px_0px_rgba(240,196,25,0.3)] flex items-center gap-2 w-fit">
                            <div class="w-2 h-2 bg-[#f0c419] rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                            <div class="w-2 h-2 bg-[#f0c419] rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                            <div class="w-2 h-2 bg-[#f0c419] rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                        </div>
                        <span class="text-xs font-bold text-gray-500 animate-pulse ml-1">Sedang mengetik...</span>
                    </div>
                `;
                list.appendChild(typing);
            }

            lucide.createIcons();
            Prism.highlightAll();
            
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSubmit(e);
            }
        }

        function clearChat() {
            if (confirm('Yakin mau hapus semua chat?')) {
                messages = [{ role: 'model', text: TOXIC_GREETINGS[Math.floor(Math.random() * TOXIC_GREETINGS.length)] }];
                renderMessages();
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const inputEl = document.getElementById('user-input');
            const text = inputEl.value.trim();
            if (!text || isLoading) return;

            messages.push({ role: 'user', text: text });
            inputEl.value = '';
            inputEl.style.height = '50px';
            
            isLoading = true;
            messages.push({ role: 'model', text: '' }); // Placeholder
            renderMessages();

            try {
                const response = await fetch('', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: messages.slice(0, -1) }) // Send history excluding placeholder
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;
                    
                    // Process buffer for SSE data lines
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.substring(6);
                            if (dataStr === '[DONE]') break;
                            
                            try {
                                const data = JSON.parse(dataStr);
                                if (data.error) {
                                    fullText = "Error: " + data.error;
                                } else if (data.chunk) {
                                    // Gemini Raw Chunk Parsing (Simplified)
                                    // The chunk is a string of JSON array elements.
                                    // We need to extract the "text" field.
                                    // This is a bit hacky because we are parsing raw chunks which might be partial JSON.
                                    // But since we are just looking for text, we can try regex or just accumulate.
                                    
                                    // Actually, Gemini stream returns: [{ "candidates": [ { "content": { "parts": [ { "text": "..." } ] } } ] }]
                                    // It might come in pieces.
                                    // Let's try to parse the chunk as JSON if it looks complete, or use regex to find "text": "..."
                                    
                                    // Regex approach for robustness in this simple script:
                                    const textMatch = data.chunk.match(/"text":\s*"((?:[^"\\]|\\.)*)"/);
                                    if (textMatch) {
                                        // Unescape JSON string
                                        const unescaped = JSON.parse('"' + textMatch[1] + '"');
                                        fullText += unescaped;
                                    }
                                }
                            } catch (e) {
                                console.error("Error parsing chunk", e);
                            }
                        }
                    }
                    
                    // Update UI
                    messages[messages.length - 1].text = fullText;
                    renderMessages();
                }

                if (!fullText) {
                    messages[messages.length - 1].text = "Gak ada output. Server lagi bapuk atau lo yang nanya gak jelas.";
                }

            } catch (error) {
                messages[messages.length - 1].text = "Maaf, terjadi kesalahan saat menghubungi server.";
            } finally {
                isLoading = false;
                renderMessages();
            }
        }

        // Initial render
        renderMessages();
    </script>
</body>
</html>
